
<html>
   <head>
      <style type="text/css">
         .sikuli-code {
            font-size: 20px;
            font-family: "Osaka-mono", Monospace;
            line-height: 1.5em;
            display:table-cell;
            white-space: pre-wrap;       /* css-3 */
            white-space: -moz-pre-wrap !important;  /* Mozilla, since 1999 */
            white-space: -pre-wrap;      /* Opera 4-6 */
            white-space: -o-pre-wrap;    /* Opera 7 */
            word-wrap: break-word;       /* Internet Explorer 5.5+ */
            width: 99%;   /* remove horizontal scroll-bar when viewing in IE7 */
         }
         .sikuli-code img {
            vertical-align: middle;
            margin: 2px;
            border: 1px solid #ccc;
            padding: 2px;
            -moz-border-radius: 5px;
            -webkit-border-radius: 5px;
            -moz-box-shadow: 1px 1px 1px gray;
            -webkit-box-shadow: 1px 1px 2px gray;
         }
         .kw {
            color: blue;
         }
         .skw {
            color: rgb(63, 127, 127);
         }

         .str {
            color: rgb(128, 0, 0);
         }

         .dig {
            color: rgb(128, 64, 0);
         }

         .cmt {
            color: rgb(200, 0, 200);
         }

         h2 {
            display: inline;
            font-weight: normal;
         }

         .info {
            border-bottom: 1px solid #ddd;
            padding-bottom: 5px;
            margin-bottom: 20px;
            display: none;
         }

         a {
            color: #9D2900;
         }

         body {
            font-family: "Trebuchet MS", Arial, Sans-Serif;
         }

      </style>
   </head>
<body>
<div class="info">
<h2>local_dirs.sikuli</h2> <a href="local_dirs.zip">(Download this script)</a>
</div>
<pre class="sikuli-code">
<span class="cmt"># Hiding local filepaths</span>
<span class="kw">from</span> local_dirs <span class="kw">import</span> screenshotsDir, target_csv

<span class="kw">import</span> shutil
<span class="kw">import</span> fnmatch
<span class="kw">import</span> os
<span class="kw">import</span> csv
<span class="kw">import</span> time
<span class="kw">from</span> datetime <span class="kw">import</span> date

<span class="kw">class</span> MonthlyListenersScrape():
    <span class="str">"""Class for scraping monthly listeners stats from Spotify Desktop client"""</span>

    <span class="kw">def</span> __init__(self, target_csv_path, screenshots_dir, chunk_size):
        self.csv_path = target_csv
        self.screenshots_dir = screenshots_dir

        self.count = <span class="dig">0</span>
        self.chunk_size = chunk_size
        self.last_chunk_index = <span class="dig">0</span>
        self.total_artists = None

        self.errors = set([])
        self.error_count = <span class="dig">0</span>

    <span class="kw">def</span> init_screenshot_dir(self):
        <span class="str">"""Creates a screenshot dir for the current date"""</span>
        today = str(date.today())
        self.screenshots_dir = self.screenshots_dir + today
        <span class="kw">if</span> <span class="kw">not</span> os.path.isdir(self.screenshots_dir):
            os.mkdir(self.screenshots_dir)

    <span class="kw">def</span> return_chunk_from_csv(self, last_index):
        <span class="kw">with</span> open(self.csv_path, <span class="str">'rb'</span>) <span class="kw">as</span> csvfile:
            contents = <span class="str">"index"</span> + csvfile.read()
            contents = contents.split(<span class="str">"\r\n"</span>)

            <span class="kw">if</span> self.total_artists <span class="kw">is</span> None:
                self.total_artists = len(contents) - <span class="dig">1</span>

        <span class="kw">if</span> last_index == self.total_artists:
            <span class="kw">return</span> None

        self.last_chunk_index = min(last_index + self.chunk_size, self.total_artists)

        row_dict = {<span class="str">"index"</span>: [], <span class="str">"track_id"</span>: [], <span class="str">"artist"</span>: [], <span class="str">"artist_id"</span>: []}
        <span class="kw">for</span> c <span class="kw">in</span> contents[last_index:min(last_index + self.chunk_size, self.total_artists)]:
            row = c.split(<span class="str">","</span>)

            <span class="kw">if</span> len(row) != <span class="dig">4</span>: <span class="kw">continue</span>
            <span class="kw">elif</span> row[<span class="dig">0</span>] == <span class="str">"index"</span>: <span class="kw">continue</span>
            <span class="kw">else</span>:
                row_dict[<span class="str">'index'</span>].append(row[<span class="dig">0</span>])
                row_dict[<span class="str">'track_id'</span>].append(row[<span class="dig">1</span>])
                row_dict[<span class="str">'artist'</span>].append(row[<span class="dig">2</span>])
                row_dict[<span class="str">'artist_id'</span>].append(row[<span class="dig">3</span>])

        <span class="kw">return</span> row_dict

    <span class="kw">def</span> save_monthly_listeners(self, artist, artist_id):
        <span class="str">"""Attempts to search for the artist and save monthly listeners as a png file."""</span>
        <span class="kw">if</span> artist == <span class="str">""</span>:
            <span class="kw">return</span> None

        <span class="skw">click</span>(<img src="search.png" />)

        <span class="kw">if</span> exists(<img src="x.png" />) <span class="kw">is</span> <span class="kw">not</span> None:
            <span class="skw">click</span>(<img src="x.png" />)
        <span class="kw">else</span>:
            <span class="skw">type</span>(<span class="str">"a"</span>)
            <span class="skw">click</span>(<img src="x.png" />)

        paste(artist)
        <span class="skw">wait</span>(<img src="top_result.png" />, <span class="dig">15</span>)
        <span class="cmt">#</span>
        <span class="cmt">#click("top_result.png")  # Verified</span>
        <span class="cmt">#</span>

        top_result_column = <span class="skw">find</span>(<img src="top_result.png" />).grow(<span class="dig">10</span>,<span class="dig">800</span>)

        <span class="cmt"># For debugging purposes</span>
        <span class="cmt">#img_2 = capture(top_result_column)</span>
        <span class="cmt">#shutil.move(img_2, os.path.join(self.screenshots_dir, str(self.count) + ".png"))</span>
        <span class="cmt">#</span>

        <span class="kw">try</span>:
            artists = top_result_column.<span class="skw">find</span>(<img src="artists.png" />)
        <span class="kw">except</span>:
            <span class="skw">click</span>(<img src="1480523888749.png" />)
            <span class="kw">return</span> None

        <span class="skw">click</span>(artists.offset(<span class="dig">0</span>,<span class="dig">20</span>))
        <span class="skw">wait</span>(<img src="related_artists.png" />)

        <span class="kw">if</span> exists(<img src="showing_results_for.png" />) <span class="kw">is</span> <span class="kw">not</span> None:
            <span class="skw">click</span>(<img src="search.png" />)

            <span class="kw">if</span> exists(<img src="x.png" />) <span class="kw">is</span> <span class="kw">not</span> None:
                <span class="skw">click</span>(<img src="x.png" />)
            <span class="kw">else</span>:
                <span class="skw">type</span>(str(self.count))
                <span class="skw">click</span>(<img src="x.png" />)

            paste(artist)
            <span class="skw">wait</span>(<img src="top_result.png" />, <span class="dig">15</span>)
            top_result_column = <span class="skw">find</span>(<img src="top_result.png" />).grow(<span class="dig">10</span>,<span class="dig">1000</span>)
            artists = top_result_column.<span class="skw">find</span>(<img src="artists.png" />)

        match = <span class="skw">find</span>(Pattern(<img src="monthly_listeners.png" />).similar(<span class="dig">0.60</span>))
        height = match.getH()
        width = match.getW()
        y_coord = match.getY()
        match.setY(y_coord - <span class="dig">2</span>*height)
        match.setH(height*<span class="dig">2</span>)
        match.setW(width + <span class="dig">3</span>)
        img = <span class="skw">capture</span>(match)
        shutil.move(img, os.path.join(self.screenshots_dir, artist_id + <img src=".png" />))

    <span class="kw">def</span> collect_artist(self, artist, artist_id):
        <span class="str">"""Attempts to collect monthly listeners as a png file, handling common errors in the process"""</span>
        <span class="kw">try</span>:
            self.save_monthly_listeners(artist, artist_id)
            self.count +=<span class="dig">1</span>
        <span class="kw">except</span>:
            <span class="kw">if</span> exists(Pattern(<img src="1480274893432.png" />).similar(<span class="dig">0.90</span>)) <span class="kw">is</span> <span class="kw">not</span> None:
                <span class="kw">print</span> <span class="str">"executed 1"</span>
                time.<span class="skw">sleep</span>(<span class="dig">300</span>)
                self.save_monthly_listeners(artist, artist_id)
            <span class="kw">if</span> exists(<img src="playback.png" />) <span class="kw">is</span> None:
                <span class="kw">print</span> <span class="str">"executed 2"</span>
                <span class="skw">click</span>(<img src="unminimize.png" />)
                self.save_monthly_listeners(artist, artist_id)
                self.count +=<span class="dig">1</span>
            <span class="kw">else</span>:
                <span class="kw">print</span> <span class="str">"executed 3"</span>
                self.errors.add(artist_id)
                self.error_count += <span class="dig">1</span>
                self.count += <span class="dig">1</span>

    <span class="kw">def</span> process_chunk(self, chunk):
        <span class="kw">for</span> a <span class="kw">in</span> range(len(chunk[<span class="str">'artist'</span>])):
            self.collect_artist(chunk[<span class="str">'artist'</span>][a], chunk[<span class="str">'artist_id'</span>][a])
        <span class="kw">print</span> <span class="str">"chunk complete"</span>

    <span class="kw">def</span> collect_all_chunks(self, first_index):
        <span class="str">"""Collects all artists between and including the two given indexes, saving a monthly listeners png file"""</span>
        self.init_screenshot_dir()

        <span class="cmt"># Return first chunk</span>
        row_dict = self.return_chunk_from_csv(first_index)

        <span class="kw">while</span> self.last_chunk_index &lt; self.total_artists:
            self.process_chunk(row_dict)
            <span class="kw">print</span> self.last_chunk_index
            row_dict = self.return_chunk_from_csv(self.last_chunk_index)

        num_pngs = len(fnmatch.filter(os.listdir(self.screenshots_dir), <span class="str">'*.png'</span>))

        <span class="kw">print</span>(<span class="str">"Process Complete"</span>)


SMS = MonthlyListenersScrape(target_csv,screenshotsDir,<span class="dig">5</span>)
SMS.collect_all_chunks(<span class="dig">0</span>)
<span class="cmt">#SMS.collect_artist("The Johnny Ortis Show", "asd;flkja")</span>

</pre>
</body>
</html>
